<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - SmartKrishi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js" type="module"></script>
    <style>
        /* Loading spinner (from my-plots.html) */
        .loading-spinner-dark {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(22, 163, 74, 0.2);
            border-top: 4px solid #16a34a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Active bottom nav style (from mandi.html) */
        .bottom-nav-item.active {
            color: #16a34a;
        }
        .bottom-nav-item.active i {
            background-color: #dcfce7;
            padding: 8px;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-100 flex justify-center">

    <div class="w-full max-w-sm h-screen bg-gray-100 flex flex-col relative overflow-hidden">

        <main class="flex-grow overflow-y-auto pb-20 p-4">

            <div class="bg-white p-4 rounded-xl shadow-sm flex items-center space-x-4 mb-6">
                <div id="profile-loading" class="w-full text-center py-4">
                    <div class="loading-spinner-dark mx-auto"></div>
                </div>
                <div id="profile-content" class="hidden flex-grow flex items-center space-x-4">
                    <img id="profile-pic" src="" class="w-16 h-16 rounded-full object-cover border-2 border-green-200">
                    <div class="flex-grow overflow-hidden">
                        <h2 id="profile-name" class="text-xl font-bold text-gray-800 truncate">Loading...</h2>
                        <p id="profile-email" class="text-gray-500 text-sm truncate">...</p>
                    </div>
                    <a href="my-profile.html" id="edit-profile-btn" class="flex-shrink-0 text-gray-500 hover:text-green-600">
                        <i class="ph ph-pencil-simple text-2xl"></i>
                    </a>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-4">
                <a href="my-profile.html" id="menu-my-profile" class="flex items-center p-4 border-b hover:bg-gray-50 transition">
                    <i class="ph ph-user-circle text-2xl text-green-600 mr-4"></i>
                    <span class="text-gray-700 font-medium flex-grow">My Profile</span>
                    <i class="ph ph-caret-right text-gray-400"></i>
                </a>
                <a href="my-transactions.html" id="menu-transactions" class="flex items-center p-4 border-b hover:bg-gray-50 transition">
                    <i class="ph ph-receipt text-2xl text-blue-600 mr-4"></i>
                    <span class="text-gray-700 font-medium flex-grow">My Transactions</span>
                    <i class="ph ph-caret-right text-gray-400"></i>
                </a>
            </div>

            <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-4">
                <a href="my-bookings.html" id="menu-bookings" class="flex items-center p-4 border-b hover:bg-gray-50 transition">
                    <i class="ph ph-truck text-2xl text-purple-600 mr-4"></i>
                    <span class="text-gray-700 font-medium flex-grow">My Bookings</span>
                    <i class="ph ph-caret-right text-gray-400"></i>
                </a>
                <a href="my-listings.html" id="menu-listings" class="flex items-center p-4 border-b hover:bg-gray-50 transition">
                    <i class="ph ph-storefront text-2xl text-yellow-600 mr-4"></i>
                    <span class="text-gray-700 font-medium flex-grow">My B2B Listings</span>
                    <i class="ph ph-caret-right text-gray-400"></i>
                </a>
                <a href="#" id="menu-saved" class="flex items-center p-4 hover:bg-gray-50 transition">
                    <i class="ph ph-bookmark-simple text-2xl text-indigo-600 mr-4"></i>
                    <span class="text-gray-700 font-medium flex-grow">Saved Posts</span>
                    <i class="ph ph-caret-right text-gray-400"></i>
                </a>
            </div>

            <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-4">
                <a href="#" id="menu-support" class="flex items-center p-4 border-b hover:bg-gray-50 transition">
                    <i class="ph ph-headset text-2xl text-gray-600 mr-4"></i>
                    <span class="text-gray-700 font-medium flex-grow">Customer Support</span>
                    <i class="ph ph-caret-right text-gray-400"></i>
                </a>
                <button id="logout-btn" class="w-full flex items-center p-4 text-left hover:bg-red-50 transition text-red-600">
                    <i class="ph ph-sign-out text-2xl mr-4"></i>
                    <span class="font-medium flex-grow">Logout</span>
                </button>
            </div>

        </main>

        <footer class="bg-white border-t border-gray-200 w-full p-2 flex justify-around items-center absolute bottom-0 z-10">
            <a href="index.html" id="home-btn" class="flex flex-col items-center text-gray-500 hover:text-green-600 p-1 rounded-md transition-colors bottom-nav-item">
                <i class="ph ph-house text-2xl"></i>
                <span class="text-xs">Home</span>
            </a>
            <a href="mandi.html" id="live-mandi-btn" class="flex flex-col items-center text-gray-500 hover:text-green-600 p-1 rounded-md transition-colors bottom-nav-item">
                <i class="ph ph-storefront text-2xl"></i>
                <span class="text-xs">Live Mandi</span>
            </a>
            <a href="my-plots.html" id="my-plots-btn" class="flex flex-col items-center text-gray-500 hover:text-green-600 p-1 rounded-md transition-colors bottom-nav-item">
                <i class="ph ph-plant text-2xl"></i>
                <span class="text-xs">My Plots</span>
            </a>
          <a href="questions.html" class="flex flex-col items-center text-gray-500 hover:text-green-600 p-1 rounded-md transition-colors bottom-nav-item">
                <i class="ph ph-question text-2xl"></i>
                <span class="text-xs">Questions</span>
            </a>
            <a href="menu.html" id="menu-btn" class="flex flex-col items-center text-green-600 p-1 rounded-md transition-colors bottom-nav-item active">
                <i class="ph ph-user-circle text-2xl"></i>
                <span class="text-xs font-semibold">Menu</span>
            </a>
        </footer>
    </div>

    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="confirm-title" class="text-lg font-semibold text-gray-800 mb-4">Confirm</h3>
            <p id="confirm-message" class="text-gray-600 mb-6">Are you sure?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-300 transition">Cancel</button>
                <button id="confirm-ok-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase config (same as your other pages)
        const firebaseConfig = {
            apiKey: "AIzaSyDg7g1N_Xjz6H-EdvW4CvAnwLiOsHlL5LE",
            authDomain: "smaart-krishi.firebaseapp.com",
            projectId: "smaart-krishi",
            storageBucket: "smaart-krishi.firebasestorage.app",
            messagingSenderId: "947583038951",
            appId: "1:947583038951:web:1a75a02ff10ee54fc73942",
            measurementId: "G-9NSMS22REQ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const profileLoading = document.getElementById('profile-loading');
        const profileContent = document.getElementById('profile-content');
        const profilePic = document.getElementById('profile-pic');
        const profileName = document.getElementById('profile-name');
        const profileEmail = document.getElementById('profile-email');
        const logoutBtn = document.getElementById('logout-btn');

        // Placeholder links (for future development)
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const menuMyProfile = document.getElementById('menu-my-profile');
        
        // Get other menu items
        const menuTransactions = document.getElementById('menu-transactions');
        const menuBookings = document.getElementById('menu-bookings');
        const menuListings = document.getElementById('menu-listings');
        const menuSaved = document.getElementById('menu-saved');
        const menuSupport = document.getElementById('menu-support');

        // Custom Modal Elements
        const confirmModal = document.getElementById('confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');

        const defaultProfileLogoUrl = "https://firebasestorage.googleapis.com/v0/b/smaart-krishi.firebasestorage.app/o/Gemini_Generated_Image_x51m66x51m66x51m.png?alt=media&token=5b1b006d-a9bc-43a1-8550-5e0b642f9dea";
        let currentUser = null;
        let onConfirmAction = null; // Stores the function to run when "OK" is clicked

        // --- Auth Check ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUserProfile(user.uid, user);
            } else {
                // Not logged in, redirect to login page
                window.location.assign('login.html');
            }
        });

        // --- Load User Profile Data ---
        async function loadUserProfile(userId, authUser) {
            try {
                const userDocRef = doc(db, "users", userId);
                const userDoc = await getDoc(userDocRef);
                let userData = null;
                
                if (userDoc.exists()) {
                    userData = userDoc.data();
                }

                // Populate UI
                // Use Firestore data first, fallback to Auth data, then to a default
                profileName.textContent = userData?.name || authUser.displayName || 'Kisan User';
                profileEmail.textContent = userData?.email || authUser.email;
                
                const picUrl = userData?.profilePicture || authUser.photoURL || defaultProfileLogoUrl;
                profilePic.src = picUrl;

            } catch (error) {
                console.error("Error loading profile:", error);
                profileName.textContent = 'Error loading profile';
                profileEmail.textContent = 'Please refresh';
            } finally {
                // Show content, hide loader
                profileLoading.classList.add('hidden');
                profileContent.classList.remove('hidden');
            }
        }

        // --- Logout Logic ---
        logoutBtn.addEventListener('click', () => {
            showConfirm("Logout", "Are you sure you want to logout?", async () => {
                // This function will run if the user clicks "OK"
                try {
                    await signOut(auth);
                    window.location.assign('login.html');
                } catch (error) {
                    console.error("Error signing out: ", error);
                    // We can use the modal to show errors too
                    showConfirm("Error", "Could not log out. Please try again.", () => {});
                }
            });
        });

        // --- Custom Confirmation Modal Functions ---
        function showConfirm(title, message, onConfirm) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            onConfirmAction = onConfirm; // Store the action
            
            // Change OK button color based on action
            if (title.toLowerCase() === 'logout' || title.toLowerCase() === 'error') {
                confirmOkBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                confirmOkBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                confirmOkBtn.textContent = (title.toLowerCase() === 'error') ? 'OK' : 'Logout';
            } else {
                confirmOkBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                confirmOkBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                confirmOkBtn.textContent = 'OK';
            }
            
            confirmModal.classList.remove('hidden');
        }

        confirmCancelBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            onConfirmAction = null; // Clear the action
        });

        confirmOkBtn.addEventListener('click', () => {
            if (onConfirmAction) {
                onConfirmAction(); // Execute the stored action
            }
            confirmModal.classList.add('hidden');
            onConfirmAction = null; // Clear the action
        });

        // --- Placeholder Listeners (for you to build out) ---
        function comingSoon(e) {
            // Prevent default link behavior
            e.preventDefault(); 
            // A simple placeholder for buttons that don't work yet
            showConfirm("Coming Soon", "This feature is under development.", () => {});
        }

        // *** CHANGED HERE: Removed listeners for profile, transactions, and bookings ***
        // editProfileBtn.addEventListener('click', comingSoon);  
        // menuMyProfile.addEventListener('click', comingSoon); 
        // menuTransactions.addEventListener('click', comingSoon);
        // menuBookings.addEventListener('click', comingSoon); 
        
        // *** CHANGED HERE: Also removed the listener for B2B Listings ***
        // menuListings.addEventListener('click', comingSoon);
        
        menuSaved.addEventListener('click', comingSoon);
        menuSupport.addEventListener('click', comingSoon);
        
    </script>
</body>
</html>